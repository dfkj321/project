# å°†èµ„é‡‘è¡¨ã€å¢ä»“è¡¨ã€DDEè¡¨ã€æ¿å—ç›‘æµ‹ã€å¤§ç›˜ç›‘æµ‹è¡¨çš„æ¯æ—¥è‚¡ç¥¨ä¿¡æ¯ï¼Œå°†excelæ–‡ä»¶è‡ªåŠ¨å¯¼å…¥æ•°æ®åº“å­˜èµ·æ¥

import pandas as pd
import os
import mysql.connector
import re
import numpy as np

# ------------------------
# æ•°æ®åº“è¿æ¥ä¿¡æ¯
# ------------------------
db_config = {
    "host": "localhost",
    "user": "root",
    "password": "123456",
    "database": "stock_analysis",
}

# ------------------------
# Excel æ–‡ä»¶å­˜æ”¾ç›®å½•
# ------------------------
directory = r"C:\Users\hucon\Desktop\stock_analysis\\"

# ------------------------
# å•ä½è½¬æ¢å‡½æ•°ï¼šå°†åŒ…å«â€œä¸‡äº¿â€ã€â€œäº¿â€æˆ–â€œä¸‡â€çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç»Ÿä¸€å•ä½ï¼ˆäº¿ï¼‰
# ------------------------
def convert_to_yi(value):
    """
    å°†åŒ…å«â€œä¸‡äº¿â€ã€â€œäº¿â€æˆ–â€œä¸‡â€çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç»Ÿä¸€å•ä½ï¼ˆäº¿ï¼‰
    - ä¾‹å¦‚ï¼š "1.80ä¸‡äº¿" -> 1.80*10000 = 18000
    - "2.4äº¿"   -> 2.4
    - "150ä¸‡"   -> 150/10000 = 0.015
    - çº¯æ•°å­—ç›´æ¥è½¬æ¢
    """
    try:
        if isinstance(value, str):
            value = value.replace(",", "").strip()
            if "ä¸‡äº¿" in value:
                return float(value.replace("ä¸‡äº¿", "")) * 10000
            elif "äº¿" in value:
                return float(value.replace("äº¿", ""))
            elif "ä¸‡" in value:
                return float(value.replace("ä¸‡", "")) / 10000
            else:
                return float(value)
        return float(value)
    except ValueError:
        return None

# ------------------------
# éœ€è¦è½¬æ¢å•ä½çš„åˆ—ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºâ€œäº¿â€ï¼‰
# ------------------------
unit_conversion_columns = {
    "capital_flow": [
        'ä¸»åŠ›å‡€æµå…¥', 'é›†åˆç«ä»·', 'è¶…å¤§å•æµå…¥', 'è¶…å¤§å•æµå‡º', 'è¶…å¤§å•å‡€é¢',
        'å¤§å•æµå…¥', 'å¤§å•æµå‡º', 'å¤§å•å‡€é¢', 'ä¸­å•æµå…¥', 'ä¸­å•æµå‡º', 'ä¸­å•å‡€é¢',
        'å°å•æµå…¥', 'å°å•æµå‡º', 'å°å•å‡€é¢'
    ],
    "market_trend": ['é‡‘é¢'],
    "sector_trend": ['æˆäº¤é‡', 'é‡‘é¢', 'æ€»å¸‚å€¼', 'æµé€šå¸‚å€¼', 'å¹³å‡è‚¡æœ¬'],
}

# ------------------------
# è¡¨åä¸æ­£ç¡®è¡¨å¤´çš„æ˜ å°„
# è¯´æ˜ï¼šé¢„æœŸè¡¨å¤´ä¸­å·²åŒ…å«â€œæ•°æ®æ—¥æœŸâ€ã€‚å¯¹äºæ¿å—ç›‘æµ‹ï¼Œé¢„æœŸè¡¨å¤´ä¸­ä¸å†åŒ…å«â€œæ¶¨è·Œå®¶æ•°â€ï¼Œè€Œæ˜¯æ‹†åˆ†æˆâ€œæ¶¨å®¶æ•°â€å’Œâ€œè·Œå®¶æ•°â€
# ------------------------
expected_columns = {
    "DDEåˆ†æ": (
        "dde_analysis",
        ['æ•°æ®æ—¥æœŸ', 'åº', 'ä»£ç ', 'åç§°', 'æœ€æ–°', 'æ¶¨å¹…%', 'DDX', 'DDY', 'DDZ',
         '5æ—¥DDX', '5æ—¥DDY', '10æ—¥DDX', '10æ—¥DDY', 'è¿ç»­', '5æ—¥å†…', '10æ—¥å†…',
         'ç‰¹å¤§ä¹°å…¥%', 'ç‰¹å¤§å–å‡º%', 'ç‰¹å¤§å•å‡€æ¯”%', 'å¤§å•ä¹°å…¥%', 'å¤§å•å–å‡º%', 'å¤§å•å‡€æ¯”%']
    ),
    "å¢ä»“åˆ†æ": (
        "position_analysis",
        ['æ•°æ®æ—¥æœŸ', 'åº', 'ä»£ç ', 'åç§°', 'æœ€æ–°', 'æ¶¨å¹…%', 'ä»Šæ—¥å¢ä»“å æ¯”',
         'ä»Šæ—¥æ’å', 'ä»Šæ—¥æ’åå˜åŒ–', 'ä»Šæ—¥æ¶¨å¹…%', '3æ—¥å¢ä»“å æ¯”', '3æ—¥æ’å',
         '3æ—¥æ’åå˜åŒ–', '3æ—¥æ¶¨å¹…%', '5æ—¥å¢ä»“å æ¯”', '5æ—¥æ’å', '5æ—¥æ’åå˜åŒ–',
         '5æ—¥æ¶¨å¹…%', '10æ—¥å¢ä»“å æ¯”', '10æ—¥æ’å', '10æ—¥æ’åå˜åŒ–', '10æ—¥æ¶¨å¹…%']
    ),
    "å¤§ç›˜ç›‘æµ‹": (
        "market_trend",
        ['æ•°æ®æ—¥æœŸ', 'åº', 'ä»£ç ', 'åç§°', 'æœ€æ–°', 'æ¶¨å¹…%', 'æ¶¨è·Œ',
         'é‡‘é¢', 'æœ€é«˜', 'æœ€ä½', 'å¼€ç›˜', 'æ˜¨æ”¶']
    ),
    "æ¿å—ç›‘æµ‹": (
        "sector_trend",
        ['æ•°æ®æ—¥æœŸ', 'åº', 'åç§°', 'æ¶¨å¹…%', '3æ—¥æ¶¨å¹…%', 'æ¶¨é€Ÿ%', 'é¢†æ¶¨è‚¡',
         'æ¶¨å®¶æ•°', 'è·Œå®¶æ•°', 'æ¶¨è·Œæ¯”', 'æ¶¨åœå®¶æ•°', 'æ¢æ‰‹%', '3æ—¥æ¢æ‰‹%',
         'æˆäº¤é‡', 'é‡‘é¢', 'æ€»å¸‚å€¼', 'æµé€šå¸‚å€¼', 'å¹³å‡æ”¶ç›Š', 'å¹³å‡è‚¡æœ¬', 'å¸‚ç›ˆç‡']
    ),
    "èµ„é‡‘æµ": (
        "capital_flow",
        ['æ•°æ®æ—¥æœŸ', 'åº', 'ä»£ç ', 'åç§°', 'æœ€æ–°', 'æ¶¨å¹…%', 'ä¸»åŠ›å‡€æµå…¥', 'é›†åˆç«ä»·',
         'è¶…å¤§å•æµå…¥', 'è¶…å¤§å•æµå‡º', 'è¶…å¤§å•å‡€é¢', 'è¶…å¤§å•å‡€å æ¯”%', 'å¤§å•æµå…¥', 'å¤§å•æµå‡º',
         'å¤§å•å‡€é¢', 'å¤§å•å‡€å æ¯”%', 'ä¸­å•æµå…¥', 'ä¸­å•æµå‡º', 'ä¸­å•å‡€é¢', 'ä¸­å•å‡€å æ¯”%',
         'å°å•æµå…¥', 'å°å•æµå‡º', 'å°å•å‡€é¢', 'å°å•å‡€å æ¯”%']
    ),
}

# ------------------------
# è¿æ¥æ•°æ®åº“
# ------------------------
conn = mysql.connector.connect(**db_config)
cursor = conn.cursor()

# ------------------------
# è·å–æ‰€æœ‰ Excel æ–‡ä»¶ï¼ˆæ’é™¤ ~$ å¼€å¤´çš„ä¸´æ—¶æ–‡ä»¶ï¼‰
# ------------------------
files = [f for f in os.listdir(directory) if f.endswith(".xlsx") and not f.startswith("~$")]

for file in files:
    file_path = os.path.join(directory, file)

    # ------------------------
    # æ ¹æ®æ–‡ä»¶åå…³é”®è¯åŒ¹é…ç›®æ ‡æ•°æ®åº“è¡¨å’Œé¢„æœŸè¡¨å¤´
    # ------------------------
    table_name = None
    expected_table_cols = None
    for keyword, (db_table, exp_cols) in expected_columns.items():
        if keyword in file:
            table_name = db_table
            expected_table_cols = exp_cols  # ä¿å­˜é¢„æœŸè¡¨å¤´
            break
    if not table_name:
        print(f"âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®åº“è¡¨ï¼Œè·³è¿‡æ–‡ä»¶ï¼š{file}")
        continue

    try:
        print(f"ğŸ“Œ å¤„ç†æ–‡ä»¶ï¼š{file}")

        # ------------------------
        # ä»æ–‡ä»¶åä¸­è§£ææ•°æ®æ—¥æœŸï¼ˆå‡è®¾æ–‡ä»¶åä¸­åŒ…å« YYYY-MM-DD æ ¼å¼çš„æ—¥æœŸï¼‰
        # ------------------------
        match = re.search(r"(\d{4}-\d{2}-\d{2})", file)
        if not match:
            print(f"âš ï¸ æ— æ³•è§£ææ–‡ä»¶æ—¥æœŸï¼Œè·³è¿‡æ–‡ä»¶ï¼š{file}")
            continue
        data_date = match.group(1)

        # ------------------------
        # è¯»å– Excel æ–‡ä»¶
        # ------------------------
        df = pd.read_excel(file_path, sheet_name=0)

        # ------------------------
        # æ ‡å‡†åŒ–åˆ—åï¼šå»é™¤å‰åç©ºæ ¼ã€æ›¿æ¢å¤šä¸ªç©ºæ ¼ï¼Œå¹¶å¡«å……ç©ºå€¼
        # ------------------------
        df.columns = df.columns.astype(str).str.strip().str.replace(r"\s+", "", regex=True).fillna("")

        # ------------------------
        # åˆ é™¤å®Œå…¨ä¸ºç©ºçš„åˆ—ï¼Œé¿å…å¤šä½™ç©ºåˆ—
        # ------------------------
        df = df.dropna(axis=1, how="all")

        # ------------------------
        # ç¡®ä¿â€œæ•°æ®æ—¥æœŸâ€åˆ—å­˜åœ¨ï¼šå¦‚æœExcelä¸­æ²¡æœ‰ï¼Œåˆ™æ’å…¥ï¼›å¦‚æœå·²å­˜åœ¨åˆ™è¦†ç›–
        # ------------------------
        if "æ•°æ®æ—¥æœŸ" not in df.columns:
            df.insert(0, "æ•°æ®æ—¥æœŸ", data_date)
        else:
            df["æ•°æ®æ—¥æœŸ"] = data_date

        # ------------------------
        # å¼ºåˆ¶â€œä»£ç â€åˆ—ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¡¥é½å‰å¯¼é›¶ï¼ˆå‡è®¾ä»£ç åº”ä¸º6ä½ï¼‰
        # ------------------------
        if "ä»£ç " in df.columns:
            df["ä»£ç "] = df["ä»£ç "].astype(str).str.strip()
            df["ä»£ç "] = df["ä»£ç "].apply(lambda x: x.zfill(6) if x.isdigit() else x)

        # ------------------------
        # åˆ é™¤â€œåºâ€åˆ—ï¼ˆå‡è®¾æ•°æ®åº“â€œåºâ€å­—æ®µä¸ºè‡ªå¢ä¸»é”®ï¼Œä¸å‚ä¸æ’å…¥ï¼‰
        # ------------------------
        if "åº" in df.columns:
            df = df.drop(columns=["åº"])
            expected_table_cols = [col for col in expected_table_cols if col != "åº"]

        # ------------------------
        # é’ˆå¯¹æ¿å—ç›‘æµ‹è¡¨ï¼šæ‹†åˆ†â€œæ¶¨è·Œå®¶æ•°â€ä¸ºâ€œæ¶¨å®¶æ•°â€å’Œâ€œè·Œå®¶æ•°â€
        # ------------------------
        if table_name == "sector_trend" and "æ¶¨è·Œå®¶æ•°" in df.columns:
            df[['æ¶¨å®¶æ•°', 'è·Œå®¶æ•°']] = df['æ¶¨è·Œå®¶æ•°'].str.split('/', expand=True)
            df['æ¶¨å®¶æ•°'] = pd.to_numeric(df['æ¶¨å®¶æ•°'].astype(str).str.strip(), errors='coerce')
            df['è·Œå®¶æ•°'] = pd.to_numeric(df['è·Œå®¶æ•°'].astype(str).str.strip(), errors='coerce')
            df.drop(columns=['æ¶¨è·Œå®¶æ•°'], inplace=True)

        # ------------------------
        # æ•°æ®å•ä½è½¬æ¢ï¼šå¯¹äºéœ€è¦è½¬æ¢å•ä½çš„å­—æ®µï¼Œç»Ÿä¸€è½¬æ¢ä¸ºâ€œäº¿â€
        # ------------------------
        if table_name in unit_conversion_columns:
            for col in unit_conversion_columns[table_name]:
                if col in df.columns:
                    df[col] = df[col].apply(lambda x: convert_to_yi(x) if pd.notnull(x) else None)

        # ------------------------
        # æ›¿æ¢ DataFrame ä¸­çš„ NaN ä¸º Noneï¼Œé˜²æ­¢ SQL é”™è¯¯
        # ------------------------
        df = df.replace({np.nan: None})

        # ------------------------
        # å¦‚æœæ˜¯æ¿å—ç›‘æµ‹ï¼Œéœ€è¦é‡æ–°æ’åºåˆ—ä»¥ç¬¦åˆé¢„æœŸé¡ºåº
        # ------------------------
        if table_name == "sector_trend":
            df = df[expected_table_cols]
        else:
            if list(df.columns) != list(expected_table_cols):
                print(f"âŒ è¡¨å¤´ä¸åŒ¹é…ï¼Œè·³è¿‡æ–‡ä»¶ï¼š{file}")
                print(f"  è¯»å–çš„è¡¨å¤´ï¼š{list(df.columns)}")
                print(f"  é¢„æœŸçš„è¡¨å¤´ï¼š{expected_table_cols}")
                continue

        # ------------------------
        # åˆ é™¤æ—§æ•°æ®ï¼ˆç›¸åŒæ•°æ®æ—¥æœŸï¼‰
        # ------------------------
        cursor.execute(f"DELETE FROM `{table_name}` WHERE `æ•°æ®æ—¥æœŸ` = %s", (data_date,))
        conn.commit()
        print(f"ğŸ—‘ï¸ å·²æ¸…é™¤ {data_date} çš„æ—§æ•°æ®")

        # ------------------------
        # æ„å»º INSERT SQL è¯­å¥ï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰å­—æ®µåŠ åå¼•å·
        # ------------------------
        columns_str = ", ".join([f"`{col}`" for col in df.columns])
        values_placeholder = ", ".join(["%s"] * len(df.columns))
        insert_query = f"INSERT INTO `{table_name}` ({columns_str}) VALUES ({values_placeholder})"

        # ------------------------
        # æ‰¹é‡æ’å…¥æ•°æ®
        # ------------------------
        cursor.executemany(insert_query, df.values.tolist())
        conn.commit()

        print(f"âœ… æˆåŠŸå¯¼å…¥ï¼š{file} -> {table_name}")

    except Exception as e:
        print(f"âŒ è§£æ Excel å¤±è´¥ï¼š{file}ï¼Œé”™è¯¯ï¼š{e}")

cursor.close()
conn.close()
print("ğŸš€ æ‰€æœ‰æ•°æ®å¯¼å…¥å®Œæˆï¼")
