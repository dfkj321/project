# ----------------- é‡ç‚¹ç›‘æ§æ¿å—æ•°æ®å¯¼å‡º -----------------
import pandas as pd
import pymysql
from datetime import datetime
import os
import glob

# ----------------- æ•°æ®åº“è¿æ¥é…ç½® -----------------
host = 'localhost'
port = 3306  # ç«¯å£å·
user = 'root'
password = '123456'
database = 'stock_analysis'
table_name = 'merged_data_specified'  # ä¾‹å¦‚ï¼šmerged_data_specified

# ----------------- åˆ é™¤æ—§çš„å¯¼å‡ºæ–‡ä»¶ -----------------
# åŒ¹é…å½“å‰ç›®å½•ä¸‹ä»¥â€œé‡ç‚¹ç›‘æ§æ¿å—æ•°æ®-â€å¼€å¤´ï¼Œä»¥â€œ.xlsxâ€ç»“å°¾çš„æ–‡ä»¶
for file in glob.glob("é‡ç‚¹ç›‘æ§æ¿å—æ•°æ®-*.xlsx"):
    try:
        os.remove(file)
        print(f"ğŸ—‘ï¸ å·²åˆ é™¤æ—§æ–‡ä»¶ï¼š{file}")
    except Exception as e:
        print(f"âš ï¸ åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼š{file}ï¼ŒåŸå› ï¼š{e}")

# ----------------- è·å–æ•°æ® -----------------
# åˆ›å»ºè¿æ¥
connection = pymysql.connect(
    host=host,
    port=port,
    user=user,
    password=password,
    database=database,
    charset='utf8mb4'
)

# æŸ¥è¯¢è¯­å¥ï¼ˆå¯æ ¹æ®éœ€è¦ç­›é€‰å­—æ®µï¼‰
query = f"SELECT * FROM {table_name}"
df = pd.read_sql(query, connection)

# å…³é—­è¿æ¥
connection.close()

# ----------------- æ•°æ®å¤„ç†ï¼šæ’åº -----------------
df['æ•°æ®æ—¥æœŸ'] = pd.to_datetime(df['æ•°æ®æ—¥æœŸ'])  # æ—¥æœŸæ ¼å¼è½¬æ¢
df_sorted = df.sort_values(by=['åç§°', 'æ•°æ®æ—¥æœŸ'], ascending=[True, False])

# ğŸ‘‰ æ ¼å¼åŒ–æ—¥æœŸï¼Œåªä¿ç•™â€œ2025å¹´03æœˆ20æ—¥â€æ ¼å¼
df_sorted['æ•°æ®æ—¥æœŸ'] = df_sorted['æ•°æ®æ—¥æœŸ'].dt.strftime('%Yå¹´%mæœˆ%dæ—¥')

# ----------------- è¡¥å……å•ä½åˆ°åˆ—å -----------------
unit_mapping = {
    'ä¸»åŠ›å‡€æµå…¥': 'ä¸»åŠ›å‡€æµå…¥/äº¿',
    'é›†åˆç«ä»·': 'é›†åˆç«ä»·/äº¿',
    'è¶…å¤§å•æµå…¥': 'è¶…å¤§å•æµå…¥/äº¿',
    'è¶…å¤§å•æµå‡º': 'è¶…å¤§å•æµå‡º/äº¿',
    'è¶…å¤§å•å‡€é¢': 'è¶…å¤§å•å‡€é¢/äº¿',
    'å¤§å•æµå…¥': 'å¤§å•æµå…¥/äº¿',
    'å¤§å•æµå‡º': 'å¤§å•æµå‡º/äº¿',
    'å¤§å•å‡€é¢': 'å¤§å•å‡€é¢/äº¿',
    'ä¸­å•æµå…¥': 'ä¸­å•æµå…¥/äº¿',
    'ä¸­å•æµå‡º': 'ä¸­å•æµå‡º/äº¿',
    'ä¸­å•å‡€é¢': 'ä¸­å•å‡€é¢/äº¿',
    'å°å•æµå…¥': 'å°å•æµå…¥/äº¿',
    'å°å•æµå‡º': 'å°å•æµå‡º/äº¿',
    'å°å•å‡€é¢': 'å°å•å‡€é¢/äº¿',
    'æˆäº¤é‡': 'æˆäº¤é‡/äº¿',
    'é‡‘é¢': 'é‡‘é¢/äº¿',
    'æ€»å¸‚å€¼': 'æ€»å¸‚å€¼/äº¿',
    'æµé€šå¸‚å€¼': 'æµé€šå¸‚å€¼/äº¿',
    'å¹³å‡è‚¡æœ¬': 'å¹³å‡è‚¡æœ¬/äº¿',
    

}

# é‡å‘½ååˆ—å
df_sorted.rename(columns=unit_mapping, inplace=True)


# ----------------- æ–‡ä»¶å‘½åä¸å¯¼å‡º -----------------
today = datetime.today().strftime('%Yå¹´%mæœˆ%dæ—¥')
filename = f'é‡ç‚¹ç›‘æ§æ¿å—æ•°æ®-{today}.xlsx'
df_sorted.to_excel(filename, index=False)

print(f"âœ… æ•°æ®å·²å¯¼å‡ºä¸ºï¼š{filename}")
